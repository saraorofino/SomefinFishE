---
title: "error_analysis"
author: "Sara Orofino"
date: "12/2/2019"
output: html_document
---

#{.tabset}

##Setup

```{r setup, include=FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#Packages
library(tidyverse)
library(here)

#Data
err_rep5c <- read_csv(file=file.path(here(),"/Results/error/error_constant_rep5.csv"))
err_rep5u <- read_csv(file=file.path(here(),"/Results/error/error_updating_rep5.csv"))
err_rep10c <- read_csv(file=file.path(here(),"/Results/error/error_constant_rep10.csv"))
err_rep10u <- read_csv(file=file.path(here(),"/Results/error/error_updating_rep10.csv"))

```


##Decision Calculation
 - Filter four categories of climate change
    - Most extreme negative 0.01767 (1.7% decrease per year)
    - Mid-range negative 0.0967 (0.97% decrease per year)
    - Lower-range negative 0.00167 (0.17% decrease per year)
    - Mid-range positive 0.01033 (1.03% increase per year)
 - Filter for assessment years ONLY
 - Group simulations by error percentage and life history
 - Count the number of times the model chose a ratio that led the manager to make the wrong decision

#Rep5
Data wrangling for 5 year intervals where Fmsy updating with climate change:
```{r wrangle-5u}

#Sequence of r_s to choose categories:
r_s = seq(-0.01767, 0.01623, 0.002)

#Assessment years:
assess_5 <- seq(5,100,5)

rep5u <- err_rep5u %>%
  filter(r_s == -0.01767 | r_s == -0.00967 | r_s == -0.00167 | r_s == 0.01033) %>% 
  filter(year == 1 | year %in% assess_5) %>% 
  filter(decision_made == "yes") %>% 
  group_by(r_s, r_0, error, correct_decision) %>% 
  tally() %>% 
  rename("count_5u" = n) %>% 
  spread(key = "correct_decision", value = "count_5u") %>%
  mutate(total_decisions_made = sum(no + yes)) %>% 
  mutate(prop_5u = no/total_decisions_made) %>% 
  mutate("r0_cat" = ifelse(r_0 <= 0.3, "slow", ifelse(r_0 > 0.3 & r_0 <= 0.5, "intermediate", "fast")))

#Now I want to transform the continuous variables (r_s and error) into factors
rep5u$r_s <- as.factor(rep5u$r_s)
rep5u$error <- as.factor(rep5u$error)

```

#Rep10
Data wrangling for 10 year intervals where Fmsy is updating with climate change:
```{r wrangle-10u}

#Assessment years:
assess_10 <- seq(10,100,10)


rep10u <- err_rep10u %>%
  filter(r_s == -0.01767 | r_s == -0.00967 | r_s == -0.00167 | r_s == 0.01033) %>% 
  filter(year == 1 | year %in% assess_10) %>% 
  filter(decision_made == "yes") %>% 
  group_by(r_s, r_0, error, correct_decision) %>% 
  tally() %>% 
  rename("count_10u" = n) %>% 
  spread(key = "correct_decision", value = "count_10u")

#There are a few scenarios where no wrong decisions are made - change these values from NA to zero
#note you need to do this before calculating any other values (ie total decisions or proportions)
rep10u$no[is.na(rep10u$no)] <- 0

rep10u_fail <- rep10u %>% 
  mutate(total_decisions_made = sum(no + yes)) %>% 
  mutate(prop_10u = no/total_decisions_made) %>% 
  mutate("r0_cat" = ifelse(r_0 <= 0.3, "slow", ifelse(r_0 > 0.3 & r_0 <= 0.5, "intermediate", "fast")))

#Now I want to transform the continuous variables (r_s and error) into factors
rep10u_fail$r_s <- as.factor(rep10u_fail$r_s)
rep10u_fail$error <- as.factor(rep10u_fail$error)


```

##Visualizations

Experiment with a few ways of visualizing this data

#Rep5

First try proportion of failures on the y-axis with error categories on the x-axis for updating Fmsy
```{r rep5-viz1}

fail5 <- ggplot(rep5u, aes(x = error, y= prop_5u)) +
  geom_jitter(aes(size = r_s, color = r0_cat), alpha = 0.8, width = 0.25)

fail5


```

#Rep10

First try proportion of failures on the y-axis with error categories on the x-axis for updating Fmsy
```{r rep10-viz1}

fail10 <- ggplot(rep10u_fail, aes(x = error, y= prop_10u)) +
  geom_jitter(aes(size = r_s, color = r0_cat), alpha = 0.8, width = 0.25)

fail10


```