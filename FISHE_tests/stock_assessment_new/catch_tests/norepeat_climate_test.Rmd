---
title: "norepeat_climate_test"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(purrr)
```



#{.tabset}

##Setup/Assumptions

Experiment: Simulate an initial stock assessment in Year 1 using catch-based data with varied amounts of error around the estimate of biomass. Make a decision on the harvest control rule based on estimate of biomass from the stock assessment. Apply that rule to the fishing mortality in year 1 and never repeat for the remainder of the simulation.This model includes a decrease in productivity over time due to climate change (r_s term).

in this test, I am using one r_s value (-0.005), which is equivalent to a 0.5% decrease in productivity each year

Assumptions: 
 - Fisheries represented in the model have no current management. Initial biomass in the simulation is therefore representative of the equilibrium that the fishery has reached over the years due to some level of fishing mortality (f). 
 - The current f at the beginning of the simulation is reached when catch is equivalent to the surplus production of the fishery at that biomass. 
 - The f calculated at the beginning of the simulation is the true fishing mortality rate of the operating fishery. 
 - Climate change is affecting the productivity of fish stocks by influeing the growth term (r)
 
 Goal: Simulate the initial use of FISHE, if it is only applied once and never repeated, focusing on the Inital Stock Assessment step of the process, with climate reducing productivity.
 
 
 ##Model
```{r model}

#Baseline model with error around initial stock assessment and no repetition of the stock assessment process for the duration of the simulation:

sim_norep_clim_test <- function(b, r, r_s, error, p, k, years){
  
  results <- data.frame(
    b = rep(NA, years), c = rep(NA, years), 
    year = 1:years, r = rep(NA, years), b_err = rep(NA, years),
    f = rep(NA, years), f_ratio = rep(NA, years)) #Setup the results dataframe 
  
  #Set the initial result for the outputs in year 1
  results$b[1] = b
  results$b_err[1] = rnorm(1, mean = results$b[1], sd = (error*results$b[1])) #simulate error in initial stock assessment
  results$r[1] = r
  results$f[1] = (results$r[1] / p) * (1 - ((results$b[1] / k) ^ p)) #initial f is based on the actual initial biomass assuming catch=surplus production
  results$c[1] = results$f[1] * results$b[1] #using f based on initial biomass and actual initial biomass
  
  fmsy <-function(r,p){r * (1 / (1+p))} #set up the function to calculate Fmsy based on growth (r) and shape parameter (p)
  f_msy <- fmsy(r=results$r[1], p=p) #calculate fmsy in year 1
  f_err = (results$r[1] / p) * (1 - ((results$b_err[1] / k) ^ p)) #calculate the f the fishery thinks it has from their initial stock assessment with error
  results$f_ratio[1] = f_err/f_msy #calculate the f_ratio using the f_err and fmsy 
  
  
  ## Loop the model over the specified number of years
  # DO NOT REPEAT the initial stock assessment - make the HCR decision and apply the f to year 2, this f remains constant 
  for (t in 2:years) {
    if(results$year[t] == 2){
    
    results$r[t] = results$r[1] * (1 + (r_s*(t-1))) 
    
    ##HCR decision will change how f is calculated - this step must come before calculating c 
    # Calculate fmsy in time t from current r 
    r_calc <- results$r[t]
    f_msy[t] <- fmsy(r=r_calc, p=p)
    
    #Decisions for f this year based on the ratio calucated this year 
    if(results$f_ratio[t-1] >= 2){
       results$f[t] = 0 #I think it makes sense for f to be zero the rest of the years but I don't know how to write that
   } 
    if(results$f_ratio[t-1] > 1 & results$f_ratio[t-1] < 2){
       results$f[t] = 0.9*results$f[t-1] #Reduce by 10% - same thing as keeping 90% of previous fishing mortality
   }  
    if(results$f_ratio[t-1] == 1){
       results$f[t] = results$f[t-1]  #f stays the same in as last year
   }
    if(results$f_ratio[t-1] < 1){
       results$f[t] = 1.05*results$f[t-1] #f increases by 5% from last year
   } 
    results$f_ratio[t] <- results$f[t]/f_msy[t] #the ratio of f/fmsy this year should be based on fishing pressure and msy from that year
    
    #Calculate remaining results - pay attention to the order!
    results$b[t] = results$b[t-1] + (results$r[t-1] / p)*results$b[t-1]*(1 - ((results$b[t-1]/k) ^ p))-results$c[t-1]
    results$b_err[t] = 0 #Don't want to redraw error this step only happens once in this simulation
    results$c[t] = results$f[t] * results$b[t]
   } 

  if(results$year[t] != 2){
    results$r[t] = results$r[1] * (1 + (r_s*(t-1)))
    results$b[t] = results$b[t-1] + (results$r[t-1] / p)*results$b[t-1]*(1 - ((results$b[t-1]/k) ^ p))-results$c[t-1]
    results$f[t] = results$f[t-1]
    results$c[t] = results$f[t] * results$b[t]
    results$b_err[t] = 0
    results$f_ratio[t] = 0
    
  }
}
  return(results)
}



```
 
##Model Check

Quick check over a simple input to be sure the model runs properly:
```{r model-check}

check_result <- sim_norep(b=6000, r=0.2, r_s=0, error=0.10, p=0.2, k=10000, years=100)

```


##Model Inputs List

Create the experiment input list:
```{r experiment-inputs}

#Design experiments
list_norep_clim_test <- list(
  b = seq(1000, 10000, 1000),
  r = 0.2,
  r_s = -0.005, #this is a -0.5% change in productivity per year - so 10% in 20 years
  error = seq(0.05, 0.55, 0.05),
  p = 0.2,
  k = 10000,
  years = 100
)

input_norep_clim_test <- list_norep_clim_test %>% 
  cross()


```

##Run

```{r run}
#Run the model over the input lists:

for(i in 1:110){
  results[[i]] <- sim_norep_clim_test(b=input_norep_clim_test[[i]]$b, r=input_norep_clim_test[[i]]$r,
                              r_s=input_norep_clim_test[[i]]$r_s, p=input_norep_clim_test[[i]]$p, 
                              k=input_norep_clim_test[[i]]$k,years=input_norep_clim_test[[i]]$years, error = input_norep_clim_test[[i]]$error)
}

```

##Save to CSV 

```{r save-to-csv}

input_norep_clim_test_df <- as.data.frame(matrix(unlist(input_norep_clim_test), nrow = length(unlist(input_norep_clim_test[110]))))
        
results_norep_clim_test_df <- as.data.frame(matrix(unlist(results), nrow = length(unlist(results[110]))))

norep_clim_test_df <- rbind(input_norep_clim_test_df, results_norep_clim_test_df)

norep_clim_test_df_final <- data.frame(t(norep_clim_test_df))

write.csv(all_df_t, "G:/Data Analysis/SomefinFishE/FISHE_tests/stock_assessment_new/catch_tests/csv_results/norep_clim_test.csv", row.names = FALSE)

#plot the results

for(i in 1:110){
 plot(results[[i]]$b)
}

```
