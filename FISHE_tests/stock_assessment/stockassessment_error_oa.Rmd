---
title: "stockassessment_error_oa"
author: "Chase"
date: "11/13/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

The goal of this test is to examine a range of error magnitude over a range of initial biomasses, with fishing mortality set at open access


```{r packages}
library(tidyverse)
```


##Foa Equation

Test the Foa equation:
Foa = (r/p) * (1-
             ((0.3 ^ (p))/
                ((p+1) ^ (1+p)))
           ) - from Sara's algebra, could be right could be wrong?
           
Result Foa for r = .2 and p = .2 is .3684 - seems very plausible, we can check this by observing where fisheries that don't collapse even out. If it is around 10-15% of carrying capacity (10,000), than this should be right
```{r fmsy}

foa = (.2/.2) * (1-
             ((0.3 ^ (.2))/
                ((.2+1) ^ (1+.2)))
           )

```

##Function
The basic function that we'll use in the rest of these tests
There is no "F" variable - instead, it is the Foa equation
```{r write_function}
#Write the function
sim_stockerror_oa <- function(b, r, r_s, error, p, k, years){
  
  results <- data.frame(
    b = rep(NA, years), c = rep(NA, years), 
    year = 1:years, r = rep(NA, years), b_err = rep(NA, years)) #Setup the results dataframe 
  
  #Set the initial result for the outputs in year 1
   
  results$b[1] = b
  results$b_err[1] = rnorm(1, mean = results$b[1], sd = (error*results$b[1])) #simulate error in assessment
  results$c[1] = ((r/p) * (1- ((0.3 ^ (p)) / ((p+1) ^ (1+p))))) * results$b_err[1] #using f=Foa and b=estimate from initial stock assessment
  results$r[1] = r
  
  #Loop the model over the specified number of years
  for (t in 2:years) {
    
    results$b_err[t] = rnorm(1, mean = results$b[t-1], sd = (error*results$b[t-1]))
    results$c[t] = ((r/p) * (1- ((0.3 ^ (p)) / ((p+1) ^ (1+p))))) * results$b_err[t]
    results$b[t] = results$b[t-1] + (results$r[t-1] / p)*results$b[t-1]*(1 - ((results$b[t-1]/k) ^ p)) - results$c[t]
    results$r[t] = results$r[1] * (1 + (r_s*(t-1))) 
    
   } 
  
  return(results)
}

results <- list()
```

##Stock Assessment
Create experiment lists
```{r create_cross_list}
# create a master list of input variables to feed into the cross() function

error_oa_experiment <- list(
  b = seq(1000, 10000, 1000),
  r = 0.2,
  r_s = 0,
  error = seq(0.05, 0.55, 0.05),
  p = 0.2,
  k = 10000,
  years = 100
)

eoae_cross <- error_oa_experiment %>% 
  cross()

# crossed lists to make 110 experiments
```

run the function
```{r run_function}

for(i in 1:110){
  results[[i]] <- sim_stockerror_oa(b=eoae_cross[[i]]$b, r=eoae_cross[[i]]$r,
                              r_s=eoae_cross[[i]]$r_s, p=eoae_cross[[i]]$p, 
                              k=eoae_cross[[i]]$k,years=eoae_cross[[i]]$years, error = eoae_cross[[i]]$error)
}

#plot the results

for(i in 1:110){
  plot(results[[i]]$b)
}
```